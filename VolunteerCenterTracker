// ==UserScript==
// @name         Volunteer Center Notifications
// @version      2025.08.22
// @description  Adds block to Notification bar to tell you how much time is left on Volunteer Center
// @author       unoriginality786
// @match        https://www.neopets.com/*
// @icon         https://images.neopets.com/themes/h5/basic/images/tvw-icon.png
// @grant        none
// ==/UserScript==

(() => {
    "use strict";

    const NOTIF_STYLE = `border-image:url(https://images.neopets.com/plots/tvw/home/images/summary-backing.png) 50 fill / 50px / 9px; color:white;padding:1em;margin-left:4px;width:96.5%;`.replace(/\s+/g, " ");

    const TIMEZONE = (() => {
        const match = new Date().toTimeString().match(/\(([^)]+)\)/);
        const zone = match ? match[1] : "UTC";
        return zone.includes(" ") ? zone.split(" ").map(w => w[0]).join("") : zone;
    })();

    const STATUS_TEXT = {
        noprogress: "Not in progress",
        inprogress: (time, zone) => `In progress until ${time} ${zone}`,
        completed: "Finished"
    };

    const present = (date, hours = 0, mins = 0, secs = 0) => {
        date.setHours(date.getHours() + hours);
        date.setMinutes(date.getMinutes() + mins);
        date.setSeconds(date.getSeconds() + secs);
        return date;
    };

    const block = (state) => {
        const saved = localStorage.getItem("tvw-bfbi-shiftend");
        const end = new Date(saved);
        const time = end.toLocaleString("en-US", {
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            hour12: true
        }).replace(",", "").replace("AM", "am").replace("PM", "pm");

        const message = {
            noprogress: STATUS_TEXT.noprogress,
            inprogress: STATUS_TEXT.inprogress(time, TIMEZONE),
            completed: STATUS_TEXT.completed
        };

        return `
<a id="tvw-notification" href="https://www.neopets.com/hospital/volunteer.phtml">
<li style="${NOTIF_STYLE}">
<h4 style="color:white;">${message[state]}</h4><br>
</li>
</a>
`;
    };

    const increment = () => {
        const alert = document.getElementById("NavAlertsNotif");
        const count = parseInt(alert.textContent) || 0;
        alert.textContent = count + 1;
        alert.style.display = "block";
        alert.style.background = "#FF46FF";
    };

    const start = () => {
        localStorage.setItem("tvw-bfbi-shiftend", present(new Date(), 6));
        document.getElementById("tvw-notification").innerHTML = block("inprogress");
    };

    const cancel = () => {
        localStorage.removeItem("tvw-bfbi-shiftend");
        document.getElementById("tvw-notification").innerHTML = block("noprogress");
    };

    const finish = () => {
        localStorage.removeItem("tvw-bfbi-shiftend");
    };

    const list = document.querySelector("#alerts > ul");
    document.querySelector("#alerts > ul > .alerts-none__2020")?.remove();
    const saved = localStorage.getItem("tvw-bfbi-shiftend");

    if (location.href === "https://www.neopets.com/hospital/volunteer.phtml") {
        const join = document.getElementById("VolunteerJoinButton");
        join?.addEventListener("click", e => {
            e.preventDefault();
            start();
        });

        const cancelbtn = document.getElementById("VolunteerCancelButton");
        cancelbtn?.addEventListener("click", e => {
            e.preventDefault();
            cancel();
        });

        const donebtn = document.getElementById("VolunteerButton3");
        donebtn?.addEventListener("click", e => {
            e.preventDefault();
            finish();
        });

        const h10 = document.getElementById("fight3HourTen");
        const h1 = document.getElementById("fight3HourOne");
        const m10 = document.getElementById("fight3MinTen");
        const m1 = document.getElementById("fight3MinOne");
        const s10 = document.getElementById("fight3SecTen");
        const s1 = document.getElementById("fight3SecOne");

        if (h10 && h1 && m10 && m1 && s10 && s1) {
            const hours = parseInt(`${h10.textContent}${h1.textContent}`);
            const mins = parseInt(`${m10.textContent}${m1.textContent}`);
            const secs = parseInt(`${s10.textContent}${s1.textContent}`);

            localStorage.setItem("tvw-bfbi-shiftend", present(new Date(), hours, mins, secs));
            list.insertAdjacentHTML("afterbegin", block("inprogress"));
        } else {
            list.insertAdjacentHTML("afterbegin", block("noprogress"));
        }
    } else {
        if (saved) {
            const end = new Date(saved);
            if (end < Date.now()) {
                increment();
                list.insertAdjacentHTML("afterbegin", block("completed"));
            } else {
                list.insertAdjacentHTML("afterbegin", block("inprogress"));
            }
        } else {
            list.insertAdjacentHTML("afterbegin", block("noprogress"));
        }
    }
})();
