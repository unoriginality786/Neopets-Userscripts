// ==UserScript==
// @name         Volunteer Center Notifications
// @version      2025.08.05
// @description  Adds a Notification to tell you how much time is left at 'Volunteer Center'
// @author       unoriginality786
// @match        https://www.neopets.com/*
// @icon         https://images.neopets.com/themes/h5/basic/images/tvw-icon.png
// @grant        none
// ==/UserScript==

(() => {
    "use strict";

    // Notification Styles
    const notif = `
      border-image:url(https://images.neopets.com/plots/tvw/home/images/summary-backing.png) 50 fill / 50px / 9px;
      color:white;padding:1em;margin-left:4px;width:96.5%;
    `.replace(/\s+/g, " ");

    const arrow = `
      width:2.5em;height:3.5em;
      background:url(https://images.neopets.com/plots/tvw/activities/void-collection/imagers/arrow.png) center/contain no-repeat;
      cursor:pointer;float:right;
    `.replace(/\s+/g, " ");

    // Utility Functions
    const present = (date, hours = 0, mins = 0, secs = 0) => {
        date.setHours(date.getHours() + hours);
        date.setMinutes(date.getMinutes() + mins);
        date.setSeconds(date.getSeconds() + secs);
        return date;
    };

    // Generate Notification Block
    const block = (state) => {
        const saved = localStorage.getItem("tvw-bfbi-shiftend");
        const end = new Date(saved);
        const time = end.toLocaleString("en-US", {
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            hour12: true
        }).replace(",", "").replace("AM", "am").replace("PM", "pm");

        const zone_match = new Date().toTimeString().match(/\(([^)]+)\)/);
        const zone = zone_match ? zone_match[1] : "UTC";
        const abbr = zone.includes(" ") ? zone.split(" ").map(w => w[0]).join("") : zone;

        const map = {
            noprogress: "Not in progress",
            inprogress: `In progress until ${time} ${abbr}`,
            completed: "Finished"
        };

        return `
        <a id="tvw-notification" href="https://www.neopets.com/hospital/volunteer.phtml">
          <li style="${notif}">
            <div class="vc-arrow right" style="${arrow}"></div>
            <h4 style="color:white;">${map[state]}</h4><br>
          </li>
        </a>
      `;
    };

    // Increment Notification Count
    const increment = () => {
        const alert = document.getElementById("NavAlertsNotif");
        const count = parseInt(alert.textContent) || 0;
        alert.textContent = count + 1;
        alert.style.display = "block";
        alert.style.background = "#FF46FF";
    };

    // Storage Access
    const list = document.querySelector("#alerts > ul");
    document.querySelector("#alerts > ul > .alerts-none__2020")?.remove();
    const saved = localStorage.getItem("tvw-bfbi-shiftend");

    // Button Handlers
    const start = () => {
        localStorage.setItem("tvw-bfbi-shiftend", present(new Date(), 6));
        document.getElementById("tvw-notification").innerHTML = block("inprogress");
    };

    const cancel = () => {
        localStorage.removeItem("tvw-bfbi-shiftend");
        document.getElementById("tvw-notification").innerHTML = block("noprogress");
    };

    const finish = () => {
        localStorage.removeItem("tvw-bfbi-shiftend");
    };

    // Main Logic
    if (location.href === "https://www.neopets.com/hospital/volunteer.phtml") {
        const join = document.getElementById("VolunteerJoinButton");
        join?.addEventListener("click", e => {
            e.preventDefault();
            start();
        });

        const cancelbtn = document.getElementById("VolunteerCancelButton");
        cancelbtn?.addEventListener("click", e => {
            e.preventDefault();
            cancel();
        });

        const donebtn = document.getElementById("VolunteerButton3");
        donebtn?.addEventListener("click", e => {
            e.preventDefault();
            finish();
        });

        const clock = document.querySelector("#VolunteerFight3 > div.vc-fight-details > div.vc-fight-status > span > script");
        if (clock) {
            const [hours, mins, secs] = clock.innerHTML
                .split("new vcClock(").pop().split(")")[0].split(", ").map(Number);
            localStorage.setItem("tvw-bfbi-shiftend", present(new Date(), hours, mins, secs));
            list.insertAdjacentHTML("afterbegin", block("inprogress"));
        } else {
            list.insertAdjacentHTML("afterbegin", block("noprogress"));
        }
    } else {
        if (saved) {
            const end = new Date(saved);
            if (end < Date.now()) {
                increment();
                list.insertAdjacentHTML("afterbegin", block("completed"));
            } else {
                list.insertAdjacentHTML("afterbegin", block("inprogress"));
            }
        } else {
            list.insertAdjacentHTML("afterbegin", block("noprogress"));
        }
    }
})();
